name: JUnit and Coverage Report # action çš„åç§°

on: # ä»€ä¹ˆæ—¶å€™è§¦å‘ action
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions: write-all

jobs:
  build: # å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    steps: # æ­¥éª¤
      - name: "æ‹‰å–ä»“åº“ä»£ç "
        uses: actions/checkout@v3
      - name: "æŸ¥çœ‹ä»£ç ç›®å½•"
        run: |
          pwd && ls -lah
      - name: "è®¾ç½®JDKç¯å¢ƒ"
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: maven # ç¼“å­˜ä¾èµ–é¡¹
      - name: "å®‰è£…Node.jsç¯å¢ƒ"
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: "å®‰è£…Mavenç¯å¢ƒ"
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: 3.8.2
      - name: "è¾“å‡ºJDKã€Mavenå’ŒNode.jsçš„ç‰ˆæœ¬"
        run: |
          mvn -v
          node -v
          java -version
      - name: "è®¾ç½®Mavenæœ¬åœ°ä»“åº“"
        uses: skjolber/maven-cache-github-action@v2.0
        with:
          step: restore
      - name: "Mavenç¼–è¯‘"
        run: |
          cd mybatis-flex-mysql8-springboot2
          mvn clean install -Dmaven.test.skip=false --batch-mode --update-snapshots verify
        env:
          TEST_JUNIT_PATH: ./target/surefire-reports/TEST-*.xml
          TEST_JACOCO_PATH: ./target/site/jacoco/jacoco.xml
      - name: "å°†ä¾èµ–jarç¼“å­˜åˆ°Mavenæœ¬åœ°ä»“åº“"
        uses: skjolber/maven-cache-github-action@v2.0
        with:
          step: save
      - name: "å•å…ƒæµ‹è¯•æŠ¥å‘Š"
        uses: EnricoMi/publish-unit-test-result-action/composite@v2
        with:
          files: |
            ${{ github.workspace }}/**/TEST-*.xml
  notice_success: # æˆåŠŸçš„é€šçŸ¥
    needs: build
    if: ${{ !cancelled() && (success() || needs.build.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - name: "æˆåŠŸçš„é€šçŸ¥"
        if: ${{ contains(needs.*.result, 'success') }}
        run: |
          echo "å¼€æºé¡¹ç›®ï¼š${{ github.repository }}"
          echo "æ„å»ºçŠ¶æ€ï¼šå•å…ƒæµ‹è¯•æ„å»ºå¤±è´¥"
          echo "å·¥ä½œæµåœ°å€ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
  #      - name: "æˆåŠŸçš„é€šçŸ¥ï¼ˆé‚®ä»¶é€šçŸ¥ï¼‰"
  #        if: ${{ contains(needs.*.result, 'success') }}
  #        uses: dawidd6/action-send-mail@v3
  #        env:
  #          MAIL_SMTP_SSL: ${{ secrets.MAIL_SMTP_SSL || false }}
  #          MAIL_SMTP_PORT: ${{ secrets.MAIL_SMTP_PORT || 25 }}
  #          MAIL_AUTH_CODE: ${{secrets.MAIL_PASSWORD}}
  #        with:
  #          server_address: ${{secrets.MAIL_SMTP_ADDRESS}} # SMTPæœåŠ¡å™¨
  #          server_port: $MAIL_SMTP_PORT # SMTP ç«¯å£å·ï¼Œé»˜è®¤ 25
  #          secure: $MAIL_SMTP_SSL # ssl
  #          username: ${{secrets.MAIL_USERNAME}} # è´¦å·
  #          password: ${{secrets.MAIL_PASSWORD}} # å¯†ç 
  #          subject: "${{ github.repository }}æ„å»ºçš„çŠ¶æ€" # ä¸»é¢˜
  #          to: ${{ github.event.head_commit.committer.email }},${{secrets.MAIL_USERNAME}} # å‘é€ç»™è°
  #          from: ${{secrets.MAIL_USERNAME}} # è°å‘é€
  #          # cc: kyloren@example.com,leia@example.com # å¯é€‰çš„æŠ„é€æ”¶ä»¶äºº
  #          # bcc: r2d2@example.com,hansolo@example.com # å¯é€‰çš„å‰¯æœ¬æ”¶ä»¶äºº
  #          # reply_to: luke@example.com # ç”µå­é‚®ä»¶å›å¤çš„å¯é€‰æ”¶ä»¶äºº
  #          # in_reply_to: <random-luke@example.com> å¯é€‰æ¶ˆæ¯IDæ­¤æ¶ˆæ¯æ­£åœ¨å›å¤
  #          # body: |
  #          # å†…å®¹
  #          # [å•å…ƒæµ‹è¯•æ„å»ºå¤±è´¥ï¼Œç‚¹å‡»æŸ¥çœ‹](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}})
  #          # å¸¦æœ‰ html æ ¼å¼çš„æ–‡æœ¬
  #          html_body: |
  #            å¼€æºé¡¹ç›®ï¼š${{ github.repository }} <br>
  #            æ„å»ºçŠ¶æ€ï¼šå•å…ƒæµ‹è¯•æ„å»ºæˆåŠŸå•¦ğŸ˜† <br>
  #            å·¥ä½œæµåœ°å€ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
  #          convert_markdown: true # è½¬æ¢ markdown
  #          ignore_cert: true # æ˜¯å¦å¿½ç•¥è¯ä¹¦
  #          # attachments: attachments.zip,git.diff,./dist/static/*.js é™„ä»¶
  #          priority: normal # ä¼˜å…ˆçº§ï¼Œ'high', 'normal' (default) or 'low'
  notice_failure: # å¤±è´¥çš„é€šçŸ¥
    needs: build
    if: ${{ !cancelled() && (failure() || needs.build.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - name: "å¤±è´¥çš„é€šçŸ¥ï¼ˆåˆ›å»ºissueï¼‰"
        if: ${{ contains(needs.*.result, 'failure') }}
        uses: actions/github-script@v6
        with:
          script: |
            // ä»“åº“çš„æ‰€æœ‰è€…
            const owner = context.payload.repository.owner.login;
            // ä»“åº“
            const repo = context.payload.repository.name;
            // æäº¤çš„ sha
            const commit = context.sha;
            // å·¥ä½œæµ
            const workflow = context.workflow;
            // è§¦å‘è€…
            const actor = context.actor;
            // æ¨é€è€…çš„é‚®ç®±
            const pusherEmail = context.payload.pusher?.email
            // æ¨é€è€…çš„å§“å
            const pusherName = context.payload.pusher?.name
            // å·¥ä½œæµåœ°å€
            const workflowRunId = context.runId;
            const workflowURL = `https://github.com/${owner}/${repo}/actions/runs/${workflowRunId}`;
            console.log('workflowURL',workflowURL)
            // æ‹¼æ¥æç¤ºæ¶ˆæ¯~
            const message = `
              [å•å…ƒæµ‹è¯•æ„å»ºå¤±è´¥ï¼Œç‚¹å‡»æŸ¥çœ‹](${workflowURL})
              æäº¤: ${commit}
              å·¥ä½œæµ: ${workflow}
              è§¦å‘è€…: ${actor}
              æäº¤è€…ï¼š${pusherName}
            `
            // è®¾ç½® issues
            const result = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'å•å…ƒæµ‹è¯•æ„å»ºå¤±è´¥',
              body: message,
              labels: ['bug','question','help wanted']
            });
            
            console.log("context ==> "+ context)
            console.log("context ==> "+ JSON.stringify(context))

#      - name: "å¤±è´¥çš„é€šçŸ¥ï¼ˆé‚®ä»¶é€šçŸ¥ï¼‰"
#        if: ${{ contains(needs.*.result, 'failure') }}
#        uses: dawidd6/action-send-mail@v3
#        env:
#          MAIL_SMTP_SSL: ${{ secrets.MAIL_SMTP_SSL || false }}
#          MAIL_SMTP_PORT: ${{ secrets.MAIL_SMTP_PORT || 25 }}
#          MAIL_AUTH_CODE: ${{secrets.MAIL_PASSWORD}}
#        with:
#          server_address: ${{secrets.MAIL_SMTP_ADDRESS}} # SMTPæœåŠ¡å™¨
#          server_port: $MAIL_SMTP_PORT # SMTP ç«¯å£å·ï¼Œé»˜è®¤ 25
#          secure: $MAIL_SMTP_SSL # ssl
#          username: ${{secrets.MAIL_USERNAME}} # è´¦å·
#          password: ${{secrets.MAIL_PASSWORD}} # å¯†ç 
#          subject: "${{ github.repository }}æ„å»ºçš„çŠ¶æ€" # ä¸»é¢˜
#          to: ${{ github.event.head_commit.committer.email }},${{secrets.MAIL_USERNAME}} # å‘é€ç»™è°
#          from: ${{secrets.MAIL_USERNAME}} # è°å‘é€
#          # cc: kyloren@example.com,leia@example.com # å¯é€‰çš„æŠ„é€æ”¶ä»¶äºº
#          # bcc: r2d2@example.com,hansolo@example.com # å¯é€‰çš„å‰¯æœ¬æ”¶ä»¶äºº
#          # reply_to: luke@example.com # ç”µå­é‚®ä»¶å›å¤çš„å¯é€‰æ”¶ä»¶äºº
#          # in_reply_to: <random-luke@example.com> å¯é€‰æ¶ˆæ¯IDæ­¤æ¶ˆæ¯æ­£åœ¨å›å¤
#          # body: |
#          # å†…å®¹
#          # [å•å…ƒæµ‹è¯•æ„å»ºå¤±è´¥ï¼Œç‚¹å‡»æŸ¥çœ‹](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}})
#          # å¸¦æœ‰ html æ ¼å¼çš„æ–‡æœ¬
#          html_body: |
#            å¼€æºé¡¹ç›®ï¼š${{ github.repository }} <br>
#            æ„å»ºçŠ¶æ€ï¼šå•å…ƒæµ‹è¯•æ„å»ºå¤±è´¥ğŸ˜‚ <br>
#            å·¥ä½œæµåœ°å€ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
#          convert_markdown: true # è½¬æ¢ markdown
#          ignore_cert: true # æ˜¯å¦å¿½ç•¥è¯ä¹¦
#          # attachments: attachments.zip,git.diff,./dist/static/*.js é™„ä»¶
#          priority: normal # ä¼˜å…ˆçº§ï¼Œ'high', 'normal' (default) or 'low'


